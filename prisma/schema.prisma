// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Room {
  id                String   @id @default(uuid())
  slug              String   @unique
  name              String?
  url               String?
  category          String?
  description       String?  @db.Text
  timeText          String?
  difficulty        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastScrapedAt     DateTime?
  scrapeStatus      ScrapeStatus @default(PENDING)
  scrapeError       String?  @db.Text
  rawSourceHash     String?
  
  tags              RoomTag[]
  tools             RoomTool[]
  lessons           Lesson[]
  relevanceScores   RelevanceAssessment[]
  
  @@index([slug])
  @@index([scrapeStatus])
  @@index([category])
  @@index([difficulty])
}

model Tag {
  id                String   @id @default(uuid())
  nameCanonical     String   @unique
  displayName       String
  type              TagType
  primaryCluster    String?
  secondaryCluster  String?
  confidence        Float?
  
  rooms             RoomTag[]
  
  @@index([type])
  @@index([nameCanonical])
}

model RoomTag {
  id           String @id @default(uuid())
  roomId       String
  tagId        String
  originalText String
  
  room         Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tag          Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, tagId])
  @@index([roomId])
  @@index([tagId])
}

model Tool {
  id           String @id @default(uuid())
  name         String @unique
  
  rooms        RoomTool[]
}

model RoomTool {
  id      String @id @default(uuid())
  roomId  String
  toolId  String
  
  room    Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tool    Tool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, toolId])
  @@index([roomId])
  @@index([toolId])
}

model Lesson {
  id      String @id @default(uuid())
  roomId  String
  content String @db.Text
  
  room    Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
}

model RelevanceAssessment {
  id            String   @id @default(uuid())
  roomId        String
  rubricKey     String
  score         Int
  justification String   @db.Text
  generatedBy   String   @default("auto")
  updatedAt     DateTime @updatedAt
  
  room          Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, rubricKey])
  @@index([roomId])
  @@index([rubricKey])
}

model ScrapeRun {
  id          String   @id @default(uuid())
  startedAt   DateTime @default(now())
  finishedAt  DateTime?
  status      String
  totalRooms  Int
  successful  Int      @default(0)
  failed      Int      @default(0)
  logs        String?  @db.Text
  
  @@index([startedAt])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  
  @@index([email])
}

enum ScrapeStatus {
  PENDING
  IN_PROGRESS
  OK
  FAILED
}

enum TagType {
  DOMAIN
  TACTIC
  TECHNIQUE
  TOOL_STACK
  ARTIFACT
  PLATFORM
}

enum UserRole {
  USER
  ADMIN
}
